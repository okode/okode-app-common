{"version":3,"sources":["../../src/providers/crashlytics.ts"],"names":[],"mappings":"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","file":"crashlytics.js","sourceRoot":"","sourcesContent":["import { Injectable } from '@angular/core';\nimport { Platform, IonicErrorHandler, AlertController } from 'ionic-angular';\nimport { SplashScreen } from '@ionic-native/splash-screen';\nimport * as StackTrace from 'stacktrace-js';\nimport { Log } from './log';\nimport { Storage } from '@ionic/storage';\n\n\nexport class CrashlyticsErrorHandler extends IonicErrorHandler {\n\n  private static APP_CRASH_DETECTED_KEY = 'OKODE_APP_CRASH_DETECTED';\n  private static APP_CRASH_MESSAGE_ES = 'La App ha detectado un error y se reiniciarÃ¡.';\n  private static APP_CRASH_MESSAGE_EN = 'An error was detected, the App will restart.';\n\n  private static APP_CRASH_QUOTA_EXCEEDED_ES = 'Optimiza el espacio disponible para poder acceder a la app';\n  private static APP_CRASH_QUOTA_EXCEEDED_EN = 'Please optimize the available storage space in order to be able to use the app';\n\n  constructor(\n    private platform: Platform,\n    private splashScreen: SplashScreen,\n    private log: Log,\n    private storage: Storage,\n    private alertCtrl: AlertController\n  ) {\n    super();\n  }\n\n  handleError(error: any) {\n    if (this.isQuotaExceededError(error)) return this.handleQuotaExceededError();\n    if (this.isIgnorableNavError(error)) { return; }\n    if (!this.platform.is('cordova') && error.rejection && error.rejection.needsRestartApp == true) {\n      this.restartApp();\n    } else {\n      super.handleError(error);\n    }\n    if (this.platform.is('cordova') && !this.isIgnorableError(error)) {\n      this.sendError(error);\n    }\n  }\n\n  async getAndClearCrashDetected() {\n    try {\n      let keys = await this.storage.keys();\n      let appWasCrashed = false;\n      if (keys.indexOf(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY) != -1) appWasCrashed = true;\n      await this.storage.remove(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY);\n      return appWasCrashed;\n    } catch (err) { }\n    return false;\n  }\n\n  private sendError(error: any) {\n    if (typeof fabric != 'undefined') {\n      if (error instanceof Error) {\n        StackTrace.fromError(error).then(frames => {\n          if (this.platform.is('android')) {\n            fabric.Crashlytics.sendNonFatalCrash(error.message, frames);\n          } else {\n            let baseHref = window.location.href.replace('www/index.html', '');\n            let report = '';\n            for (let frame of frames) {\n              report += `${frame.functionName}(${frame.fileName.replace(baseHref, '')}:${frame.lineNumber})\\n`;\n            }\n            fabric.Crashlytics.sendNonFatalCrash(`${error.name}: ${error.message}\\n\\n${report}`);\n          }\n          this.displayErrorMsgAndReload();\n        }).catch(reason => this.log.e('Crashlytics catch: ' + reason));\n      } else {\n        fabric.Crashlytics.sendNonFatalCrash(JSON.stringify(error));\n        this.displayErrorMsgAndReload();\n      }\n    }\n  }\n\n  private displayErrorMsgAndReload() {\n    this.splashScreen.hide();\n    let isLangES = navigator.language.startsWith('es');\n    this.alertCtrl.create({\n      title: 'Error',\n      message: isLangES ? CrashlyticsErrorHandler.APP_CRASH_MESSAGE_ES : CrashlyticsErrorHandler.APP_CRASH_MESSAGE_EN,\n      enableBackdropDismiss: false,\n      buttons: [{\n        text: isLangES ? 'Aceptar' : 'OK',\n        handler: () => {\n          this.log.e(CrashlyticsErrorHandler.APP_CRASH_MESSAGE_EN);\n          this.log.e(`Creating entry in local storage for ${CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY} = true`);\n          this.storage.set(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY, true).then(() => {\n            this.splashScreen.show();\n            this.restartApp();\n          }).catch(() => {\n            this.splashScreen.show();\n            this.restartApp();\n          });\n        }\n      }]\n    }).present();\n  }\n\n  private restartApp() {\n    let href = window.location.href;\n    if (href.indexOf('/www/index.html') > 0) {\n      href = href.substring(0, href.indexOf('/www/index.html') + '/www/index.html'.length);\n    } else {\n      href = '/';\n    }\n    window.location.href = href;\n  }\n\n  private isIgnorableError(error: any) {\n    if (error !== undefined && error.status !== undefined && error.status >= 400) return true;\n    return false;\n  }\n\n  private isIgnorableNavError(error: any) {\n    if (!error || !error.message) { return false; }\n    let message = error.message;\n    /**\n     * Messages got from:\n     * https://github.com/ionic-team/ionic/blob/ae4be669bb96de01ff2224ff36da89e9cde12c7f/src/navigation/nav-controller-base.ts#L322\n     *\n     */\n    if (\n      message.includes('navigation stack needs at least one root page') ||\n      message.includes('no views in the stack to be removed') ||\n      message.includes('removeView was not found')\n    ) {\n      this.log.e(`Ignoring Ionic nav error ${message}`);\n      return true;\n    }\n    return false;\n  }\n\n  isQuotaExceededError(error: any) {\n    if (error) {\n      if (error.rejection && error.rejection.QUOTA_EXCEEDED_ERR == DOMException.QUOTA_EXCEEDED_ERR) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  handleQuotaExceededError() {\n    this.splashScreen.hide();\n    let isLangES = navigator.language.startsWith('es');\n    this.alertCtrl.create({\n      title: 'Error',\n      message: isLangES ? CrashlyticsErrorHandler.APP_CRASH_QUOTA_EXCEEDED_ES : CrashlyticsErrorHandler.APP_CRASH_QUOTA_EXCEEDED_EN,\n      enableBackdropDismiss: false,\n      buttons: [{\n        text: isLangES ? 'Aceptar' : 'OK',\n        handler: () => {\n          this.log.e(CrashlyticsErrorHandler.APP_CRASH_QUOTA_EXCEEDED_EN);\n          this.log.e(`Creating entry in local storage for ${CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY} = true`);\n          this.storage.set(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY, true).then(() => {\n            this.splashScreen.show();\n            this.restartApp();\n          }).catch(() => {\n            this.splashScreen.show();\n            this.restartApp();\n          });\n        }\n      }]\n    }).present();\n  }\n\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: Platform, },\n{type: SplashScreen, },\n{type: Log, },\n{type: Storage, },\n{type: AlertController, },\n];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}