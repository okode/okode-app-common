{"version":3,"sources":["../../src/providers/crashlytics.ts"],"names":[],"mappings":"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","file":"crashlytics.js","sourceRoot":"","sourcesContent":["import { Injectable, isDevMode } from '@angular/core';\nimport { Platform, IonicErrorHandler, AlertController } from 'ionic-angular';\nimport { SplashScreen } from '@ionic-native/splash-screen';\nimport * as StackTrace from 'stacktrace-js';\nimport { Log } from './log';\nimport { Storage } from '@ionic/storage';\n\n\nexport class CrashlyticsErrorHandler extends IonicErrorHandler {\n\n  private static APP_CRASH_DETECTED_KEY = 'OKODE_APP_CRASH_DETECTED';\n  private static APP_CRASH_MESSAGE_ES = 'La App ha detectado un error y se reiniciará.';\n  private static APP_CRASH_MESSAGE_EN = 'An error was detected, the App will restart.';\n\n  constructor(\n    private platform: Platform,\n    private splashScreen: SplashScreen,\n    private log: Log,\n    private storage: Storage,\n    private alertCtrl: AlertController\n  ) {\n    super();\n  }\n\n  handleError(error: any) {\n    if (this.isIgnorableNavError(error)) { return; }\n    super.handleError(error);\n    if (!isDevMode() && !this.isAnIgnorableError(error)) {\n      this.sendError(error);\n    }\n  }\n\n  async getAndClearCrashDetected() {\n    try {\n      let keys = await this.storage.keys();\n      let appWasCrashed = false;\n      if (keys.indexOf(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY) != -1) appWasCrashed = true;\n      await this.storage.remove(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY);\n      return appWasCrashed;\n    } catch (err) {}\n    return false;\n  }\n\n  private sendError(error: any) {\n    if (typeof fabric != 'undefined') {\n      if (error instanceof Error) {\n        StackTrace.fromError(error).then(frames => {\n          if (this.platform.is('android')) {\n            fabric.Crashlytics.sendNonFatalCrash(error.message, frames);\n          } else {\n            let baseHref = window.location.href.replace('www/index.html', '');\n            let report = '';\n            for (let frame of frames) {\n              report += `${frame.functionName}(${frame.fileName.replace(baseHref, '')}:${frame.lineNumber})\\n`;\n            }\n            fabric.Crashlytics.sendNonFatalCrash(`${error.name}: ${error.message}\\n\\n${report}`);\n          }\n          this.displayErrorMsgAndReload();\n        }).catch(reason => this.log.e('Crashlytics catch: ' + reason));\n      } else {\n        fabric.Crashlytics.sendNonFatalCrash(JSON.stringify(error));\n        this.displayErrorMsgAndReload();\n      }\n    }\n  }\n\n  private displayErrorMsgAndReload() {\n    this.splashScreen.hide();\n    let isLangES = navigator.language.startsWith('es');\n    this.alertCtrl.create({\n      title: 'Error',\n      message: isLangES ? CrashlyticsErrorHandler.APP_CRASH_MESSAGE_ES : CrashlyticsErrorHandler.APP_CRASH_MESSAGE_EN,\n      buttons: [{\n        text: isLangES ? 'Aceptar' : 'OK',\n        handler: () => {\n          this.log.e(CrashlyticsErrorHandler.APP_CRASH_MESSAGE_EN);\n          this.log.e(`Creating entry in local storage for ${CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY} = true`);\n          this.storage.set(CrashlyticsErrorHandler.APP_CRASH_DETECTED_KEY, true).then(() => {\n            this.splashScreen.show();\n            window.location.reload();\n          }).catch(() => {\n            this.splashScreen.show();\n            window.location.reload();\n          });\n        }\n      }]\n    }).present();\n  }\n\n  private isAnIgnorableError(error: any) {\n    if (error && error.status == 500) return true;\n    return false;\n  }\n\n  private isIgnorableNavError(error: any) {\n    if (!error || !error.message) { return false; }\n    let message = error.message;\n    /**\n     * Messages got from:\n     * https://github.com/ionic-team/ionic/blob/ae4be669bb96de01ff2224ff36da89e9cde12c7f/src/navigation/nav-controller-base.ts#L322\n     *\n     */\n    if (\n      message.includes('navigation stack needs at least one root page') ||\n      message.includes('no views in the stack to be removed') ||\n      message.includes('removeView was not found')\n    ) {\n      this.log.e(`Ignoring Ionic nav error ${message}`);\n      return true;\n    }\n    return false;\n  }\n\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: Platform, },\n{type: SplashScreen, },\n{type: Log, },\n{type: Storage, },\n{type: AlertController, },\n];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}